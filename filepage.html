<!DOCTYPE HTML>
<html>
	<head>
		<title>Scala Editor</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="stylesheet" href="assets/css/main.css" />
	</head>
	<body class="is-preload">
		<link rel="stylesheet" href="theme/yeti.css">
		<link rel="stylesheet" href="lib/codemirror.css">
		<link rel="stylesheet" href="addon/dialog/dialog.css">
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/browser.min.js"></script>
		<script src="assets/js/breakpoints.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="theme/yeti.css"></script>
		<script src="lib/codemirror.js"></script>
		<script src="mode/clike/clike.js"></script>
		<script src="addon/edit/matchbrackets.js"></script>
		<script src="addon/edit/closebrackets.js"></script>
		<script src="addon/dialog/dialog.js"></script>
		<script src="addon/search/searchcursor.js"></script>
		<script src="addon/search/search.js"></script>
		<script src="addon/scroll/annotatescrollbar.js"></script>
		<script src="addon/search/matchesonscrollbar.js"></script>
		<script src="addon/search/jump-to-line.js"></script>
		<script src="addon/search/match-highlighter.js"></script>
		<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
		<style type="text/css">
			.CodeMirror {border-top: 1px solid black; border-bottom: 1px solid black;}
			.CodeMirror-focused .cm-matchhighlight {
				background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAIAAAACCAYAAABytg0kAAAAFklEQVQI12NgYGBgkKzc8x9CMDAwAAAmhwSbidEoSQAAAABJRU5ErkJggg==);
				background-position: bottom;
				background-repeat: repeat-x;
			}
			.cm-matchhighlight {background-color: rgb(219, 221, 199)}
			.CodeMirror-selection-highlight-scrollbar {background-color: rgb(212, 248, 212)}
			</style>
			<div id="wrapper">
				<header id="header">
						<h1><a onclick="go_to_filepage();">Scala Editor</a></h1>
						<nav class="links">
						   <ul>
							  <li class="dropdown">
								 <a href="javascript:void(0)" class="dropbtn">My Editor</a>
								 <div class="dropdown-content">
									<a href="#">Log Out</a>								 </div>
							  <li>
						   </ul>
						</nav>
						<nav class="main">
								<ul>
									<li class="menu">
										<a class="fa-bars" href="#menu">Menu</a>
									</li>
								</ul>
							</nav>
						</header>
	  
					<section id="menu">
							<section>
									<ul class="links" id="filelinks">
									</ul>
								</section>
								<section>
									<ul class="actions stacked">
										<li><a class="button large fit">Log Out</a></li>
									</ul>
								</section>
	
						</section>

					<div id="main">
						<section id="intro">
									<header>
										<p id="codename">codename</a></p>
									</header>
						</section>
						<form name = "code_form"><textarea id="code_text">
							</textarea></form>
							<p><button type="button" onclick="save_to_server();">Save</button>
							<button type="button" onclick="btn_run_click();">Run</button>
							<h5>StdIn</h5>
							<form class = "inputform" name = "std_inform"><textarea rows="2" id="std_in" name = "std_in"></textarea></form></p>
							<h5>StdOut</h5>
							<form name = "result_form"><textarea rows = "5" id="result_text" name ="result_text"></textarea></form>
							  <script>
								var array = "";
								array = ["slide1", "slide2", "slide3", "slide4", "slide5", "slide6"]
								//when loaded, get the file list
								window.addEventListener('DOMContentLoaded', function(){ 
										var xh = new XMLHttpRequest();
										xh.open("GET", 'http://52.231.65.108:8080/api/files', true);
										xh.send(null);
										xh.onreadystatechange = function() {
																if (xh.readyState == XMLHttpRequest.DONE) {
																	var resultJSON = xh.response; 
																	result_obj = JSON.parse(resultJSON);
																	array = result_obj.projects;
																}
															}	
									});
									//for rendering - go back to the filepage
									function go_to_filepage() {
										location.replace('/myprojects');
									}
									//code for coding area
								var editor = CodeMirror.fromTextArea(document.getElementById("code_text"), {
									lineNumbers: true,
									matchBrackets: true,
									autoCloseBrackets: true,
        							theme: "yeti",
									mode: "text/x-scala",
									highlightSelectionMatches: {showToken: /\w/, annotateScrollbar: true},
									onCursorActivity: function() {
    									editor.matchHighlight("CodeMirror-matchhighlight");
									  }
								});
								//generating list elements for file tree
								array.forEach(function(item) {
                				var li = document.createElement("li");
                				var text = document.createTextNode(item);
                				li.innerHTML = "<a onclick='link_click(this);' id="+item+">"+"<h3>"+item+"</h3>";
                				document.getElementById("filelinks").appendChild(li);
                				});
								//when file name is clicked, get the code from the server
								function link_click(element){
									let selected = element.getAttribute('id');
									console.log(selected);
									document.getElementById("codename").innerText = selected+".scala";
									var fileJSON = {"filename" : selected};
									var filestring = JSON.stringify(fileJSON);
									console.log(filestring);
									var xhr1 = new XMLHttpRequest();
									xhr1.open("POST", 'http://52.231.65.108:8080/files/select', true);
									xhr1.setRequestHeader('Access-Control-Allow-Origin', '*');
									xhr1.setRequestHeader("Access-Control-Allow-Credentials", "true");
									xhr1.setRequestHeader("Content-Type", "application/json");
									xhr1.send(filestring);
									xhr1.onreadystatechange = function() {
										if (xhr1.readyState == XMLHttpRequest.DONE) {
											var file_resultJSON = xhr1.response;
											file_result_obj = JSON.parse(file_resultJSON);
											editor.value = file_result_obj.code;
										}
									}
								}
								//when the save button is clicked
								function save_to_server() {
									var savecode = editor.getValue();
									swal({
											text: 'Enter the Class Name',
											content: "input",
											button: {
												text: "Run",
												closeModal: false,
											},
										})
										.then(value => {
											if (!value) throw null;
											save_code_to_server(savecode, value);
										})
								}
								//send code to server for saving
								function save_code_to_server(savecode, saveclassname) {
										var savecodeJSON = {"classname" : saveclassname, "code" : savecode};
										var savecodestring = JSON.stringify(savecodeJSON);
										console.log(savecodestring);
										var save_xhr = new XMLHttpRequest();
										save_xhr.open("POST", 'http://52.231.65.108:8080/save', true);
										save_xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
										save_xhr.setRequestHeader("Access-Control-Allow-Credentials", "true");
										save_xhr.setRequestHeader("Content-Type", "application/json");
										save_xhr.send(savecodestring);
										save_xhr.onreadystatechange = function() {
											if (save_xhr.readyState == XMLHttpRequest.DONE) {
												swal('Saved!');
											}
										}	
									}
								//when the run button is clicked
								function btn_run_click(){
										document.result_form.result_text.value = "";
										var std_input = document.std_inform.std_in.value;
										var codestring = editor.getValue();
										swal({
											text: 'Enter the Class Name',
											content: "input",
											button: {
												text: "Run",
												closeModal: false,
											},
										})
										.then(value => {
											if (!value) throw null;
											run_code_to_server(codestring, value, std_input);
											swal('Go!');
										})
      								}
									//send code to server for compiling
									function run_code_to_server(codestring, class_name, std_input) {
										var codeJSON = {"classname" : class_name, "code" : codestring, "input" : std_input};
										var codestring = JSON.stringify(codeJSON);
										console.log(codestring);
										var xhr = new XMLHttpRequest();
										xhr.open("POST", 'http://52.231.65.108:8080/api/run', true);
										xhr.setRequestHeader('Access-Control-Allow-Origin', '*');
										xhr.setRequestHeader("Access-Control-Allow-Credentials", "true");
										xhr.setRequestHeader("Content-Type", "application/json");
										xhr.send(codestring);
										xhr.onreadystatechange = function() {
											if (xhr.readyState == XMLHttpRequest.DONE) {
												var resultJSON = xhr.response; 
												result_obj = JSON.parse(resultJSON);
												document.result_form.result_text.value = result_obj.output;
											}
										}	
									}
								
							  </script>
			</div>
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>
	</body>
</html>